<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard - ayaFinance</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        
        <!-- ADD MOBILE RESPONSIVE CSS -->
        <style>
            /* Mobile First Responsive Design */
            @media (max-width: 768px) {
                /* Navigation responsive */
                .nav-links {
                    display: none;
                }
                
                /* KEEP DESKTOP PROFILE VISIBLE ON MOBILE TOO */
                .desktop-profile {
                    display: flex !important;
                }
                
                /* Hide notification on mobile to save space */
                .mobile-hide-notification {
                    display: none !important;
                }
                
                /* Adjust profile dropdown for mobile */
                #profileDropdown {
                    right: 0;
                    left: auto;
                    width: 200px !important;
                    margin-top: 0.5rem;
                }
                
                /* Stats cards responsive */
                .stats-grid {
                    grid-template-columns: 1fr 1fr !important;
                    gap: 0.75rem !important;
                }
                
                /* Charts responsive */
                .chart-container {
                    height: 250px !important;
                }
                
                /* Transaction list responsive */
                .transaction-item {
                    padding: 0.75rem !important;
                }
                
                /* Card responsive */
                .mobile-card {
                    padding: 1rem !important;
                }
                
                /* Hide less important elements */
                .mobile-hide {
                    display: none !important;
                }
            }
            
            @media (max-width: 480px) {
                /* Extra small devices */
                .stats-grid {
                    grid-template-columns: 1fr !important;
                }
                
                /* Even smaller profile dropdown */
                #profileDropdown {
                    width: 180px !important;
                }
                
                .chart-container {
                    height: 200px !important;
                }
            }
            
            /* Touch friendly elements */
            .touch-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Prevent zoom on input focus */
            input[type="date"], 
            input[type="text"], 
            input[type="number"], 
            select {
                font-size: 16px !important;
            }
            .mobile-text-2xl {
    font-size: 1.5rem !important;
}

@media (max-width: 640px) {
    .mobile-text-2xl {
        font-size: 1.25rem !important;
    }
}

/* Prevent text overflow */
.break-words {
    word-wrap: break-word;
    word-break: break-word;
}

/* Ensure minimum width for flex children */
.min-w-0 {
    min-width: 0;
}
        </style>
    </head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-wallet text-white text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800">ayaFinance</h1>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex space-x-6 nav-links">
                    <a href="dashboard.html" class="text-blue-600 font-medium border-b-2 border-blue-600 pb-1">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                    <a href="transactions.html" class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-list mr-2"></i>Transaksi
                    </a>
                </div>
                
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="mobileMenuBtn" class="text-gray-600 hover:text-gray-800 touch-btn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
                
                <!-- Profile Section - VISIBLE ON ALL SCREENS -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <!-- Notification - Hide on mobile -->
                    <div class="relative hidden md:block">
                        <button id="notificationBtn" class="text-gray-600 hover:text-gray-800 relative touch-btn">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                        </button>
                    </div>
                    
                    <!-- User Info - Hide on mobile -->
                    <div class="text-right hidden md:block">
                        <p id="welcomeUser" class="text-sm font-medium text-gray-700">Admin</p>
                        <p class="text-xs text-gray-500">Administrator</p>
                    </div>
                    
                    <!-- Profile Button - SINGLE INSTANCE -->
                    <div class="relative">
                        <button id="profileBtn" class="flex items-center space-x-1 md:space-x-2 bg-gray-100 hover:bg-gray-200 px-2 md:px-3 py-2 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-blue-500 touch-btn">
                            <div id="profileAvatar" class="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center bg-gradient-to-r from-blue-500 to-cyan-500">
                                <!-- Avatar image will be injected by JS -->
                            </div>
                            <i class="fas fa-chevron-down text-gray-500 text-xs hidden md:inline"></i>
                        </button>
                        
                        <!-- Profile Dropdown - SINGLE INSTANCE -->
                        <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden z-50">
                            <div class="py-1">
                                <div class="px-4 py-2 border-b border-gray-100">
                                    <p class="text-sm font-medium text-gray-700">Administrator</p>
                                    <p class="text-xs text-gray-500">admin@ayafinance.com</p>
                                </div>
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-user mr-2"></i>Profile Saya
                                </a>
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-cog mr-2"></i>Pengaturan
                                </a>
                                <a href="#" id="refreshProfileBtn" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh Profile
                                </a>
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-bell mr-2"></i>Notifikasi
                                </a>
                                <hr class="my-1">
                                <button id="logoutBtn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="md:hidden hidden border-t border-gray-200 py-4">
                <div class="space-y-3">
                    <a href="dashboard.html" class="block text-blue-600 font-medium py-2">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </a>
                    <a href="transactions.html" class="block text-gray-600 hover:text-blue-600 transition-colors py-2">
                        <i class="fas fa-list mr-2"></i>Transaksi
                    </a>
                    <div class="border-t border-gray-200 pt-3 mt-3">
                        <div class="flex items-center space-x-3 py-2">
                            <div id="profileAvatar" class="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center bg-gradient-to-r from-blue-500 to-cyan-500">
                                <!-- Avatar image will be injected by JS -->
                            </div>
                            <div>
                                <p id="mobileWelcomeUser" class="text-sm font-medium text-gray-700">Admin</p>
                                <p class="text-xs text-gray-500">Administrator</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header Section -->
        <div class="mb-8 bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-2xl border border-purple-100">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-globe text-purple-600 mr-3"></i>
                        Dashboard Global
                    </h2>
                    <p class="text-gray-600" id="dashboardSubtitle">Selamat datang! Berikut adalah ringkasan keuangan dari semua pengguna.</p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <div class="bg-purple-50 border border-purple-200 px-4 py-2 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-globe text-purple-600"></i>
                            <span class="text-sm font-medium text-purple-800" id="currentUserDisplay">Data Global - Semua User</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8 stats-grid">
            <!-- Total Balance -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Total Saldo (Semua User)</p>
                        <p class="text-lg md:text-3xl font-bold text-gray-800 mobile-text-2xl break-words" id="totalBalance">Rp 0</p>
                        <p class="text-xs md:text-sm text-green-600 mt-1">
                           <!--  <i class="fas fa-arrow-up text-xs mr-1"></i>
                            +2.5% dari bulan lalu-->
                        </p>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                        <i class="fas fa-wallet text-white text-sm md:text-xl"></i>
                    </div>
                </div>
            </div>
        
            <!-- Income -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Pemasukan Bulan Ini (Global)</p>
                        <p class="text-lg md:text-3xl font-bold text-green-600 mobile-text-2xl break-words" id="monthlyIncome">Rp 0</p>
                        <p class="text-xs md:text-sm text-green-600 mt-1">
                            <!-- <i class="fas fa-arrow-up text-xs mr-1"></i>
                            +12% dari bulan lalu-->
                        </p>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-emerald-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                        <i class="fas fa-arrow-up text-white text-sm md:text-xl"></i>
                    </div>
                </div>
            </div>
        
            <!-- Expenses -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Pengeluaran Bulan Ini (Global)</p>
                        <p class="text-lg md:text-3xl font-bold text-red-600 mobile-text-2xl break-words" id="monthlyExpense">Rp 0</p>
                        <p class="text-xs md:text-sm text-red-600 mt-1">
                            <!-- <i class="fas fa-arrow-down text-xs mr-1"></i>
                            -5% dari bulan lalu-->
                        </p>
                    </div>
                    <div class="bg-gradient-to-r from-red-500 to-pink-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                        <i class="fas fa-arrow-down text-white text-sm md:text-xl"></i>
                    </div>
                </div>
            </div>
        
            <!-- Savings -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Jumlah User Aktif</p>
                        <p class="text-lg md:text-3xl font-bold text-purple-600 mobile-text-2xl break-words" id="activeUsers">0</p>
                        <p class="text-xs md:text-sm text-gray-500 mt-1" id="totalTransactions">0 transaksi total</p>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                        <i class="fas fa-users text-white text-sm md:text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Separator -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <div class="border-t border-gray-200 flex-grow"></div>
                <div class="mx-6">
                    <div class="bg-gradient-to-r from-gray-400 to-gray-600 text-white px-6 py-2 rounded-full text-sm font-medium shadow-md">
                        <i class="fas fa-chevron-down mr-2"></i>
                        Dashboard Personal
                        <i class="fas fa-chevron-down ml-2"></i>
                    </div>
                </div>
                <div class="border-t border-gray-200 flex-grow"></div>
            </div>
        </div>

        <!-- Personal Dashboard Section -->
        <div class="mb-8 bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-2xl border border-green-100">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-user-circle text-green-600 mr-3"></i>
                        Dashboard Personal
                    </h2>
                    <p class="text-gray-600">Ringkasan keuangan pribadi Anda</p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <div class="bg-green-50 border border-green-200 px-4 py-2 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user-circle text-green-600"></i>
                            <span class="text-sm font-medium text-green-800" id="personalUserDisplay">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8 stats-grid">
                <!-- Personal Total Balance -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Saldo Personal Anda</p>
                            <p class="text-lg md:text-3xl font-bold text-gray-800 mobile-text-2xl break-words" id="personalTotalBalance">Rp 0</p>
                            <p class="text-xs md:text-sm text-blue-600 mt-1">
                                <i class="fas fa-user text-xs mr-1"></i>
                                Data pribadi
                            </p>
                        </div>
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                            <i class="fas fa-wallet text-white text-sm md:text-xl"></i>
                        </div>
                    </div>
                </div>
            
                <!-- Personal Income -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Pemasukan Personal</p>
                            <p class="text-lg md:text-3xl font-bold text-green-600 mobile-text-2xl break-words" id="personalMonthlyIncome">Rp 0</p>
                            <p class="text-xs md:text-sm text-green-600 mt-1">
                                <i class="fas fa-calendar-alt text-xs mr-1"></i>
                                Bulan ini
                            </p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-emerald-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                            <i class="fas fa-arrow-up text-white text-sm md:text-xl"></i>
                        </div>
                    </div>
                </div>
            
                <!-- Personal Expenses -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Pengeluaran Personal</p>
                            <p class="text-lg md:text-3xl font-bold text-red-600 mobile-text-2xl break-words" id="personalMonthlyExpense">Rp 0</p>
                            <p class="text-xs md:text-sm text-red-600 mt-1">
                                <i class="fas fa-calendar-alt text-xs mr-1"></i>
                                Bulan ini
                            </p>
                        </div>
                        <div class="bg-gradient-to-r from-red-500 to-pink-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                            <i class="fas fa-arrow-down text-white text-sm md:text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Personal Transaction Count -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 hover:shadow-md transition-shadow mobile-card">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs md:text-sm font-medium text-gray-500 mb-1">Transaksi Anda</p>
                            <p class="text-lg md:text-3xl font-bold text-indigo-600 mobile-text-2xl break-words" id="personalTransactionCount">0</p>
                            <p class="text-xs md:text-sm text-gray-500 mt-1" id="personalMonthlyTransactions">0 bulan ini</p>
                        </div>
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-500 w-8 h-8 md:w-12 md:h-12 rounded-lg flex items-center justify-center flex-shrink-0 ml-2">
                            <i class="fas fa-list-alt text-white text-sm md:text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
                <!-- Personal Category Breakdown -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 mobile-card">
                    <div class="flex items-center justify-between mb-4 md:mb-6">
                        <h3 class="text-base md:text-lg font-semibold text-gray-800">Kategori Pengeluaran Personal</h3>
                    </div>
                    <div class="relative h-48 md:h-64 chart-container">
                        <canvas id="personalCategoryChart"></canvas>
                    </div>
                </div>

                <!-- Personal Monthly Trend -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 mobile-card">
                    <div class="flex items-center justify-between mb-4 md:mb-6">
                        <h3 class="text-base md:text-lg font-semibold text-gray-800">Trend Personal</h3>
                        <div class="text-xs text-gray-500">6 bulan terakhir</div>
                    </div>
                    <div class="relative h-48 md:h-64 chart-container">
                        <canvas id="personalTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
            <!-- Income vs Expense Chart -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 mobile-card">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 md:mb-6">
                    <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-2 sm:mb-0">Pemasukan vs Pengeluaran (Global)</h3>
                    <select class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-1 text-sm w-full sm:w-auto">
                        <option>6 Bulan Terakhir</option>
                        <option>3 Bulan Terakhir</option>
                        <option>12 Bulan Terakhir</option>
                    </select>
                </div>
                <div class="relative h-48 md:h-64 chart-container">
                    <canvas id="incomeExpenseChart"></canvas>
                </div>
            </div>
        
            <!-- Category Breakdown -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 mobile-card">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h3 class="text-base md:text-lg font-semibold text-gray-800">Kategori Pengeluaran (Global)</h3>
                </div>
                <div class="relative h-48 md:h-64 chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">Aksi Cepat</h3>
            <div class="space-y-3">
                <button id="addTransactionBtn" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>
                    Tambah Transaksi
                </button>
                <button class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-chart-line mr-2"></i>
                    Lihat Laporan
                </button>
                <button class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-target mr-2"></i>
                    Set Target
                </button>
                <button id="categoriesBtn" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-tags mr-2"></i>
                    Kelola Kategori
                </button>
                
                <!-- DEBUG BUTTON - TEMPORARY -->
                <button id="debugProfileBtn" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center mb-2">
                    <i class="fas fa-bug mr-2"></i>
                    Debug Profile Picture
                </button>
                
                <!-- DEBUG BUTTON FOR USER DISPLAY -->
                <button id="debugUserDisplayBtn" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-user-edit mr-2"></i>
                    Debug User Display
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Transaksi -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-screen overflow-y-auto modal-content">
            <div class="p-4 md:p-6">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h3 class="text-lg md:text-xl font-semibold text-gray-800">
                        <i class="fas fa-plus-circle text-blue-500 mr-2"></i>
                        Tambah Transaksi
                    </h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 touch-btn">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
    
                <!-- Transaction Form -->
                <form id="transactionForm" class="space-y-4">
                    <!-- Transaction Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Transaksi</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" id="incomeBtn" class="transaction-type-btn bg-green-50 border-2 border-green-200 text-green-700 py-3 px-4 rounded-lg font-medium hover:bg-green-100 transition-colors touch-btn mobile-btn">
                                <i class="fas fa-arrow-up mr-2"></i>
                                Pemasukan
                            </button>
                            <button type="button" id="expenseBtn" class="transaction-type-btn bg-red-50 border-2 border-red-200 text-red-700 py-3 px-4 rounded-lg font-medium hover:bg-red-100 transition-colors touch-btn mobile-btn">
                                <i class="fas fa-arrow-down mr-2"></i>
                                Pengeluaran
                            </button>
                        </div>
                        <input type="hidden" id="transactionType" name="type" required>
                    </div>
    
                    <!-- Amount -->
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">Rp</span>
                            </div>
                            <input type="text" id="amount" name="amount" class="block w-full pl-12 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" required min="1">
                            <input type="hidden" id="amountValue" name="amountValue">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Format: 1.000.000</p>
                    </div>
    
                    <!-- Category -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <select id="category" name="category" class="block w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            <option value="">Pilih Kategori</option>
                        </select>
                    </div>
    
                    <!-- Description -->
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                        <input type="text" id="description" name="description" class="block w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan deskripsi transaksi" required>
                    </div>
    
                    <!-- Date -->
                    <div>
                        <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                        <input type="date" id="transactionDate" name="date" class="block w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
    
                    <!-- Submit Button -->
                    <div>
                        <button id="submitBtn" type="submit" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 touch-btn">
                            Simpan Transaksi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat AI Section -->
    <div id="chatAI" class="fixed bottom-20 right-6 bg-white rounded-xl shadow-lg w-80 z-50 border transition-all duration-300 opacity-0 pointer-events-none scale-95" style="display:none;">
        <div class="p-4 border-b font-bold text-blue-600 flex justify-between items-center">
            Chat AI
            <button id="closeChatAI" class="text-gray-400 hover:text-red-500 text-xl font-bold">&times;</button>
        </div>
        <div id="chatMessages" class="p-4 h-64 overflow-y-auto text-sm"></div>
        <form id="chatForm" class="flex border-t">
            <input id="chatInput" type="text" class="flex-1 px-3 py-2 focus:outline-none" placeholder="Tulis pesan...">
            <button type="submit" class="px-4 text-blue-600 font-bold">Kirim</button>
        </form>
    </div>

    <div id="chatAITab" style="position:fixed;bottom:1.5rem;right:1.5rem;z-index:40;cursor:pointer;">
        <div class="bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg font-bold flex items-center gap-2">
            <i class="fas fa-robot"></i> Chat AI
        </div>
    </div>

    <!-- LOAD CHART.JS FIRST - BEFORE OUR SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
const supabase = window.supabase.createClient(
  'https://jjieqhvfadoqkahpqdvl.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqaWVxaHZmYWRvcWthaHBxZHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NjExODEsImV4cCI6MjA2ODEzNzE4MX0.8rwAFQew3HbzdBgoseq_DX-R6YwJB2Fk5OMgm4KrmBM');

        console.log('ðŸ“Š Dashboard script loading...');
        
        // Global variables
        let currentUser = null;
        let allTransactions = [];
        
        // Check login status
        function checkLogin() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                window.location.href = 'login.html';
                return null;
            }
            return user;
        }
        
        // Format currency function - SIMPLE VERSION
        function formatCurrencySimple(amount) {
            const numAmount = parseFloat(amount) || 0;
            const isNegative = numAmount < 0;
            const absAmount = Math.abs(numAmount);
            
            // Format number with dots
            const formatted = absAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            // Return with proper sign
            if (isNegative) {
                return `- Rp ${formatted}`;
            }
            
            return `Rp ${formatted}`;
        }
        
        // Alternative currency format
        function formatCurrency(amount) {
            return formatCurrencySimple(amount); // Use simple version
        }
        
        function showError(message) {
    alert('âŒ ' + message);
}

        // Load dashboard data from database
        async function loadDashboardData() {
    console.log('ðŸ“Š Loading dashboard data...');
    showLoadingState();

    // Ambil user dari localStorage
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        window.location.href = 'login.html';
        return;
    }

    console.log('ðŸ‘¤ Loading data for all users (global dashboard)');

    // Ambil SEMUA transaksi dari SEMUA user
    const { data: transactions, error } = await supabase
        .from('transactions')
        .select('*');

    if (error) {
        console.error('âŒ Error fetching transactions:', error);
        showError('Gagal mengambil data transaksi: ' + error.message);
        showErrorState();
        return;
    }

    console.log(`âœ… Loaded ${transactions ? transactions.length : 0} total transactions from all users`);
    
    // Hitung berapa user yang memiliki transaksi
    const uniqueUsers = transactions ? [...new Set(transactions.map(t => t.user_id))].length : 0;
    console.log(`ðŸ‘¥ Data from ${uniqueUsers} unique users`);
    
    // Update dashboard dengan semua transaksi
    updateDashboardMetrics(transactions || [], uniqueUsers);
    await renderCategoryExpenseChart(transactions || []);
    
    // Load personal dashboard data
    await loadPersonalDashboardData(transactions || []);
    
    hideLoadingState();
}

function hideLoadingState() {
    // Contoh: reset tampilan loading ke normal
    const elements = [
        { id: 'totalBalance', class: 'text-lg md:text-3xl font-bold text-gray-800 mobile-text-2xl break-words' },
        { id: 'monthlyIncome', class: 'text-lg md:text-3xl font-bold text-green-600 mobile-text-2xl break-words' },
        { id: 'monthlyExpense', class: 'text-lg md:text-3xl font-bold text-red-600 mobile-text-2xl break-words' }
    ];
    elements.forEach(el => {
        const element = document.getElementById(el.id);
        if (element) element.className = el.class;
    });
}
        
        // Show loading state
        function showLoadingState() {
            const elements = [
                { id: 'totalBalance', value: 'Loading...', class: 'text-lg md:text-3xl font-bold text-gray-400 animate-pulse mobile-text-2xl break-words' },
                { id: 'monthlyIncome', value: 'Loading...', class: 'text-lg md:text-3xl font-bold text-gray-400 animate-pulse mobile-text-2xl break-words' },
                { id: 'monthlyExpense', value: 'Loading...', class: 'text-lg md:text-3xl font-bold text-gray-400 animate-pulse mobile-text-2xl break-words' }
            ];
            
            elements.forEach(el => {
                const element = document.getElementById(el.id);
                if (element) {
                    element.textContent = el.value;
                    element.className = el.class;
                }
            });
        }
        
        // Show error state
        function showErrorState() {
            const elements = [
                { id: 'totalBalance', value: 'Error Loading', class: 'text-lg md:text-3xl font-bold text-red-500 mobile-text-2xl break-words' },
                { id: 'monthlyIncome', value: 'Error Loading', class: 'text-lg md:text-3xl font-bold text-red-500 mobile-text-2xl break-words' },
                { id: 'monthlyExpense', value: 'Error Loading', class: 'text-lg md:text-3xl font-bold text-red-500 mobile-text-2xl break-words' }
            ];
            
            elements.forEach(el => {
                const element = document.getElementById(el.id);
                if (element) {
                    element.textContent = el.value;
                    element.className = el.class;
                }
            });
        }
        
        // Update dashboard metrics
        function updateDashboardMetrics(transactions, uniqueUsers = 0) {
            console.log('ðŸ“ˆ Calculating dashboard metrics from all users...');
            console.log(`ðŸ“Š Processing ${transactions.length} total transactions from ${uniqueUsers} users`);
            
            // Get current month and year
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            console.log('ðŸ“… Current month/year:', currentMonth, currentYear);
            
            // Calculate total balance (all time) - DARI SEMUA TRANSAKSI SEMUA USER
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const totalBalance = totalIncome - totalExpense;
            
            // Calculate current month income and expense - DARI SEMUA TRANSAKSI SEMUA USER
            const currentMonthTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const transactionMonth = transactionDate.getMonth() + 1;
                const transactionYear = transactionDate.getFullYear();
                
                return transactionMonth === currentMonth && transactionYear === currentYear;
            });
            
            const monthlyIncome = currentMonthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const monthlyExpense = currentMonthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            console.log('ðŸ’° Global financial metrics:', {
                totalBalance,
                monthlyIncome,
                monthlyExpense,
                totalTransactions: transactions.length,
                currentMonthTransactions: currentMonthTransactions.length,
                uniqueUsers: uniqueUsers
            });
            
            // Update DOM elements
            updateDashboardElement('totalBalance', totalBalance, 
                totalBalance >= 0 ? 'text-lg md:text-3xl font-bold text-gray-800 mobile-text-2xl break-words' : 'text-lg md:text-3xl font-bold text-red-600 mobile-text-2xl break-words');
            updateDashboardElement('monthlyIncome', monthlyIncome, 'text-lg md:text-3xl font-bold text-green-600 mobile-text-2xl break-words');
            updateDashboardElement('monthlyExpense', monthlyExpense, 'text-lg md:text-3xl font-bold text-red-600 mobile-text-2xl break-words');
            
            // Update user count display
            const currentUserDisplay = document.getElementById('currentUserDisplay');
            if (currentUserDisplay) {
                currentUserDisplay.textContent = `Data Global - ${uniqueUsers} User${uniqueUsers !== 1 ? 's' : ''}`;
            }
            
            // Update stats card
            const activeUsersElement = document.getElementById('activeUsers');
            if (activeUsersElement) {
                activeUsersElement.textContent = uniqueUsers;
            }
            
            const totalTransactionsElement = document.getElementById('totalTransactions');
            if (totalTransactionsElement) {
                totalTransactionsElement.textContent = `${transactions.length} transaksi total`;
            }
            
            console.log('âœ… Global dashboard metrics updated successfully');
        }
        
        // Update individual dashboard element
        function updateDashboardElement(elementId, value, className) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = formatCurrencySimple(value);
                element.className = className;
                console.log(`âœ… Updated ${elementId}: ${formatCurrencySimple(value)}`);
            } else {
                console.log(`âŒ Element ${elementId} not found in DOM`);
            }
        }
        
        async function renderCategoryExpenseChart(transactions) {
    console.log('ðŸ“Š Rendering category expense chart with', transactions.length, 'transactions from all users');
    
    // Ambil kategori pengeluaran dari database
    const { data: categories, error } = await supabase
        .from('categories')
        .select('id, name')
        .eq('type', 'expense');
    
    if (error || !categories) {
        console.error('âŒ Error fetching categories:', error);
        return;
    }

    // Hitung total pengeluaran per kategori dari SEMUA USER
    const expenseByCategory = {};
    categories.forEach(cat => expenseByCategory[cat.id] = 0);

    transactions
        .filter(t => t.type === 'expense')
        .forEach(t => {
            if (expenseByCategory[t.category_id] !== undefined) {
                expenseByCategory[t.category_id] += parseFloat(t.amount || 0);
            }
        });

    console.log('ðŸ’° Global category expenses:', expenseByCategory);

    // Siapkan data chart
    const labels = categories.map(cat => cat.name);
    const data = categories.map(cat => expenseByCategory[cat.id]);

    // Render chart
    const ctx2 = document.getElementById('categoryChart');
    if (ctx2) {
        if (window.categoryChart && typeof window.categoryChart.destroy === 'function') {
            window.categoryChart.destroy();
        }
        window.categoryChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgb(59, 130, 246)',
                        'rgb(34, 197, 94)',
                        'rgb(239, 68, 68)',
                        'rgb(168, 85, 247)',
                        'rgb(249, 115, 22)',
                        'rgb(251, 191, 36)',
                        'rgb(16, 185, 129)',
                        'rgb(236, 72, 153)'
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: 'Pengeluaran Semua User'
                    }
                }
            }
        });
        console.log('âœ… Global category chart rendered successfully');
    }
}

        // Load personal dashboard data
        async function loadPersonalDashboardData(allTransactions) {
            console.log('ðŸ‘¤ Loading personal dashboard data...');
            
            // Get current user
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;
            
            let userId = currentUser.id;
            if (userId && userId.includes(':')) {
                userId = userId.split(':')[0];
            }
            
            // Filter transaksi untuk user yang login
            const userTransactions = allTransactions.filter(t => t.user_id === userId);
            console.log(`ðŸ“Š Found ${userTransactions.length} transactions for current user`);
            
            // Update personal dashboard
            updatePersonalDashboardMetrics(userTransactions, currentUser);
            await renderPersonalCategoryChart(userTransactions);
            await renderPersonalTrendChart(userTransactions);
        }
        
        // Update personal dashboard metrics
        function updatePersonalDashboardMetrics(transactions, currentUser) {
            console.log('ðŸ“ˆ Calculating personal dashboard metrics...');
            
            // Get current month and year
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            // Calculate personal totals
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const personalBalance = totalIncome - totalExpense;
            
            // Calculate current month personal data
            const currentMonthTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const transactionMonth = transactionDate.getMonth() + 1;
                const transactionYear = transactionDate.getFullYear();
                
                return transactionMonth === currentMonth && transactionYear === currentYear;
            });
            
            const monthlyIncome = currentMonthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const monthlyExpense = currentMonthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            console.log('ðŸ’° Personal financial metrics:', {
                personalBalance,
                monthlyIncome,
                monthlyExpense,
                totalTransactions: transactions.length,
                monthlyTransactions: currentMonthTransactions.length
            });
            
            // Update personal DOM elements
            updateDashboardElement('personalTotalBalance', personalBalance, 
                personalBalance >= 0 ? 'text-lg md:text-3xl font-bold text-gray-800 mobile-text-2xl break-words' : 'text-lg md:text-3xl font-bold text-red-600 mobile-text-2xl break-words');
            updateDashboardElement('personalMonthlyIncome', monthlyIncome, 'text-lg md:text-3xl font-bold text-green-600 mobile-text-2xl break-words');
            updateDashboardElement('personalMonthlyExpense', monthlyExpense, 'text-lg md:text-3xl font-bold text-red-600 mobile-text-2xl break-words');
            
            // Update personal info
            const personalUserDisplay = document.getElementById('personalUserDisplay');
            if (personalUserDisplay) {
                personalUserDisplay.textContent = `Data: ${currentUser.full_name || currentUser.username || 'User'}`;
                console.log('âœ… Personal user display updated in loadPersonalDashboardData:', personalUserDisplay.textContent);
            }
            
            // Update transaction counts
            const personalTransactionCount = document.getElementById('personalTransactionCount');
            if (personalTransactionCount) {
                personalTransactionCount.textContent = transactions.length;
            }
            
            const personalMonthlyTransactions = document.getElementById('personalMonthlyTransactions');
            if (personalMonthlyTransactions) {
                personalMonthlyTransactions.textContent = `${currentMonthTransactions.length} bulan ini`;
            }
            
            console.log('âœ… Personal dashboard metrics updated successfully');
        }

        // Render personal category chart
        async function renderPersonalCategoryChart(transactions) {
            console.log('ðŸ‘¤ Rendering personal category chart...');
            
            // Ambil kategori pengeluaran dari database
            const { data: categories, error } = await supabase
                .from('categories')
                .select('id, name')
                .eq('type', 'expense');
            
            if (error || !categories) {
                console.error('âŒ Error fetching categories:', error);
                return;
            }

            // Hitung pengeluaran per kategori untuk user ini
            const expenseByCategory = {};
            categories.forEach(cat => expenseByCategory[cat.id] = 0);

            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (expenseByCategory[t.category_id] !== undefined) {
                        expenseByCategory[t.category_id] += parseFloat(t.amount || 0);
                    }
                });

            // Siapkan data chart
            const labels = categories.map(cat => cat.name);
            const data = categories.map(cat => expenseByCategory[cat.id]);

            // Render chart
            const ctx = document.getElementById('personalCategoryChart');
            if (ctx) {
                if (window.personalCategoryChart && typeof window.personalCategoryChart.destroy === 'function') {
                    window.personalCategoryChart.destroy();
                }
                
                window.personalCategoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                'rgb(34, 197, 94)',   // Green
                                'rgb(59, 130, 246)',  // Blue
                                'rgb(239, 68, 68)',   // Red
                                'rgb(168, 85, 247)',  // Purple
                                'rgb(249, 115, 22)',  // Orange
                                'rgb(251, 191, 36)',  // Yellow
                                'rgb(16, 185, 129)',  // Emerald
                                'rgb(236, 72, 153)'   // Pink
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff',
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: { usePointStyle: true }
                            }
                        }
                    }
                });
                console.log('âœ… Personal category chart rendered');
            }
        }

        // Render personal trend chart
        async function renderPersonalTrendChart(transactions) {
            console.log('ðŸ‘¤ Rendering personal trend chart...');
            
            // Generate last 6 months data
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                
                // Month label
                months.push(date.toLocaleDateString('id-ID', { month: 'short' }));
                
                // Filter transactions for this month
                const monthTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getMonth() + 1 === month && 
                           transactionDate.getFullYear() === year;
                });
                
                // Calculate income and expense
                const monthIncome = monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    
                const monthExpense = monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
            }

            // Render chart
            const ctx = document.getElementById('personalTrendChart');
            if (ctx) {
                if (window.personalTrendChart && typeof window.personalTrendChart.destroy === 'function') {
                    window.personalTrendChart.destroy();
                }
                
                window.personalTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Pemasukan',
                            data: incomeData,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointBackgroundColor: 'rgb(34, 197, 94)',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }, {
                            label: 'Pengeluaran',
                            data: expenseData,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointBackgroundColor: 'rgb(239, 68, 68)',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return 'Rp ' + (value / 1000000) + 'M';
                                        } else if (value >= 1000) {
                                            return 'Rp ' + (value / 1000) + 'K';
                                        }
                                        return 'Rp ' + value;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('âœ… Personal trend chart rendered');
            }
        }

        // Initialize charts - FIXED VERSION
        function initializeCharts() {
            console.log('ðŸ“Š Initializing charts...');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js is not loaded!');
                return;
            }
            
            // Income vs Expense Chart - menampilkan data global
            const ctx1 = document.getElementById('incomeExpenseChart');
            if (ctx1) {
                console.log('ðŸ“Š Creating global income expense chart...');
                
                // Safe destroy
                if (window.incomeExpenseChart && typeof window.incomeExpenseChart.destroy === 'function') {
                    window.incomeExpenseChart.destroy();
                }
                
                try {
                    window.incomeExpenseChart = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Pemasukan Global',
                                data: [0, 0, 0, 0, 0, 0], // Data akan diupdate dengan data semua user
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: 'Pengeluaran Global',
                                data: [0, 0, 0, 0, 0, 0], // Data akan diupdate dengan data semua user
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'bottom' },
                                title: {
                                    display: true,
                                    text: 'Data dari semua pengguna'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return 'Rp ' + (value / 1000000) + 'M';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('âœ… Global income vs expense chart initialized');
                } catch (error) {
                    console.error('âŒ Error creating global income expense chart:', error);
                }
            }
        
        }
        
        // Transaction type selection
        function selectTransactionType(type) {
            console.log('ðŸ·ï¸ Selecting transaction type:', type);
            
            const incomeBtn = document.getElementById('incomeBtn');
            const expenseBtn = document.getElementById('expenseBtn');
            const typeInput = document.getElementById('transactionType');
            
            // Reset both buttons
            if (incomeBtn) {
                incomeBtn.classList.remove('bg-green-200', 'border-green-400');
                incomeBtn.classList.add('bg-green-50', 'border-green-200');
            }
            
            if (expenseBtn) {
                expenseBtn.classList.remove('bg-red-200', 'border-red-400');
                expenseBtn.classList.add('bg-red-50', 'border-red-200');
            }
            
            // Highlight selected button
            if (type === 'income' && incomeBtn) {
                incomeBtn.classList.remove('bg-green-50', 'border-green-200');
                incomeBtn.classList.add('bg-green-200', 'border-green-400');
            } else if (type === 'expense' && expenseBtn) {
                expenseBtn.classList.remove('bg-red-50', 'border-red-200');
                expenseBtn.classList.add('bg-red-200', 'border-red-400');
            }
            
            // Set hidden input value
            if (typeInput) {
                typeInput.value = type;
            }
            
            // Update category options
            updateCategoryOptions(type);
        }
        
        // Update category options
        async function updateCategoryOptions(type) {
    const categorySelect = document.getElementById('category');
    if (!categorySelect) return;
    
    try {
        // Show loading in select
        categorySelect.innerHTML = '<option value="">Memuat kategori...</option>';
        categorySelect.disabled = true;
        
        // Fetch categories from API
        categorySelect.innerHTML = '<option value="">Memuat kategori...</option>';
categorySelect.disabled = true;

const { data: categories, error } = await supabase
    .from('categories')
    .select('*')
    .eq('type', type);

if (!error && categories) {
    categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        option.dataset.icon = category.icon || '';
        option.dataset.color = category.color || '';
        categorySelect.appendChild(option);
    });
    console.log(`âœ… Loaded ${categories.length} categories for type: ${type}`);
} else {
    // Fallback ke kategori statis jika gagal
    // ... (kode fallback Anda)
    alert('âš ï¸ Gagal memuat kategori dari database. Menggunakan kategori default.');
}
categorySelect.disabled = false;
        
    } catch (error) {
        console.error('âŒ Error loading categories:', error);
        
        // Fallback to static categories (same as before)
        categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
        
        let fallbackCategories = [];
        if (type === 'income') {
            fallbackCategories = [
                { id: 'salary', name: 'Gaji' },
                { id: 'freelance', name: 'Freelance' },
                { id: 'investment', name: 'Investasi' },
                { id: 'business', name: 'Bisnis' },
                { id: 'gift', name: 'Hadiah' },
                { id: 'other_income', name: 'Lainnya' }
            ];
        } else {
            fallbackCategories = [
                { id: 'food', name: 'Makanan' },
                { id: 'transportation', name: 'Transportasi' },
                { id: 'shopping', name: 'Belanja' },
                { id: 'bills', name: 'Tagihan' },
                { id: 'health', name: 'Kesehatan' },
                { id: 'entertainment', name: 'Hiburan' },
                { id: 'education', name: 'Pendidikan' },
                { id: 'other_expense', name: 'Lainnya' }
            ];
        }
        
        fallbackCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
        });
        
        alert('âš ï¸ Gagal memuat kategori dari database. Menggunakan kategori default.');
    } finally {
        categorySelect.disabled = false;
    }
}
        
        // Handle form submission
        async function handleFormSubmission() {
    console.log('ðŸ“ Processing form submission...');
    
    const submitBtn = document.getElementById('submitBtn');
    
    // Show loading state
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
    }
    
    try {
        // Get current user
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            throw new Error('User tidak ditemukan. Silakan login kembali.');
        }

        let userId = currentUser.id;
        if (userId && userId.includes(':')) {
            userId = userId.split(':')[0];
        }

        // Get form values
        const typeValue = document.getElementById('transactionType').value;
        const amountValue = document.getElementById('amount').value.replace(/\./g, '');
        const categoryValue = document.getElementById('category').value;
        const descriptionValue = document.getElementById('description').value;
        const dateValue = document.getElementById('transactionDate').value;
        
        // Validation
        if (!typeValue) {
            throw new Error('Pilih jenis transaksi (Pemasukan/Pengeluaran)');
        }
        
        if (!amountValue || parseFloat(amountValue) <= 0) {
            throw new Error('Masukkan jumlah yang valid');
        }
        
        if (!categoryValue) {
            throw new Error('Pilih kategori transaksi');
        }
        
        if (!descriptionValue.trim()) {
            throw new Error('Masukkan deskripsi transaksi');
        }
        
        if (!dateValue) {
            throw new Error('Pilih tanggal transaksi');
        }
        
        // Get category name for legacy field
        const categorySelect = document.getElementById('category');
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categoryName = selectedOption ? selectedOption.textContent : '';
        
        console.log('ðŸ“Š Form data for user', userId, ':', {
            type: typeValue,
            amount: amountValue,
            category_id: categoryValue,
            category_name: categoryName,
            description: descriptionValue,
            date: dateValue
        });
        
        // Simpan transaksi dengan user_id yang benar
        const { error } = await supabase.from('transactions').insert([{
            user_id: userId,
            type: typeValue,
            amount: parseFloat(amountValue),
            category_id: categoryValue,
            category: categoryName,
            description: descriptionValue,
            date: dateValue
        }]);

        if (!error) {
            // Close modal
            document.getElementById('transactionModal').classList.add('hidden');
            // Reset form
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionType').value = '';
            // Reload both global and personal dashboard data
            await loadDashboardData();
            alert('âœ… Transaksi berhasil disimpan! Dashboard global dan personal telah diperbarui.');
        } else {
            throw new Error(error.message || 'Gagal menyimpan transaksi');
        }

        
    } catch (error) {
        console.error('âŒ Form submission error:', error);
        alert('âŒ Error: ' + error.message);
    } finally {
        // Reset submit button
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Simpan Transaksi';
        }
    }
}
        
        // SINGLE DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ DOM Content Loaded');
            
            // Check login
            currentUser = checkLogin();
            if (!currentUser) return;
            
            // Pastikan user ID dalam format yang benar
            if (currentUser.id && currentUser.id.includes(':')) {
                currentUser.id = currentUser.id.split(':')[0];
            }
            
            console.log('âœ… User logged in:', currentUser.username || currentUser.full_name, 'ID:', currentUser.id);
            
            // Debug user data untuk troubleshooting foto profil
            console.log('ðŸ” User data debug:', {
                id: currentUser.id,
                username: currentUser.username,
                full_name: currentUser.full_name,
                email: currentUser.email,
                photo_url: currentUser.photo_url
            });
            
            // TAMPILKAN FOTO PROFIL USER DI BUTTON PROFILE
            console.log('ðŸ–¼ï¸ Starting profile picture setup...');
            
            // Langsung update semua profile avatar
            updateProfileAvatars(currentUser);
            
            // Update semua user display elements (no await needed)
            updateAllUserDisplays();
            
            // Juga setup untuk update berkala
            setTimeout(() => {
                console.log('ðŸ”„ Secondary profile picture update...');
                updateProfileAvatars(currentUser);
                updateAllUserDisplays();
            }, 500);
            
            // Update welcome message (backup method)
            const welcomeElement = document.getElementById('welcomeUser');
if (welcomeElement) {
    welcomeElement.textContent = currentUser.full_name || currentUser.username || currentUser.name || 'Admin';
    console.log('âœ… Welcome user updated (backup):', welcomeElement.textContent);
}
const emailElement = welcomeElement?.nextElementSibling;
if (emailElement) {
    emailElement.textContent = currentUser.email || '';
}

// Update mobile welcome user (backup method)
const mobileWelcomeUser = document.getElementById('mobileWelcomeUser');
if (mobileWelcomeUser) {
    mobileWelcomeUser.textContent = currentUser.full_name || currentUser.username || currentUser.name || 'User';
    console.log('âœ… Mobile welcome user updated (backup):', mobileWelcomeUser.textContent);
}
const mobileEmail = mobileWelcomeUser?.nextElementSibling;
if (mobileEmail) {
    mobileEmail.textContent = currentUser.email || '';
}

// Update profile dropdown info (backup method)
const profileDropdownInfo = document.querySelector('#profileDropdown .border-b p');
if (profileDropdownInfo) {
    profileDropdownInfo.textContent = currentUser.full_name || currentUser.username || currentUser.name || 'Administrator';
    console.log('âœ… Profile dropdown name updated (backup):', profileDropdownInfo.textContent);
}
const profileDropdownEmail = document.querySelector('#profileDropdown .border-b p + p');
if (profileDropdownEmail) {
    profileDropdownEmail.textContent = currentUser.email || 'user@ayafinance.com';
    console.log('âœ… Profile dropdown email updated (backup):', profileDropdownEmail.textContent);
}

// Update personal dashboard user display
const personalUserDisplay = document.getElementById('personalUserDisplay');
if (personalUserDisplay) {
    personalUserDisplay.textContent = `Data: ${currentUser.full_name || currentUser.username || 'User'}`;
    console.log('âœ… Personal user display updated:', personalUserDisplay.textContent);
}

// Panggil juga function khusus untuk memastikan
updatePersonalUserDisplay();

        // Dashboard tetap menampilkan data global - tidak perlu update user display lagi
        
        // Refresh profile picture - fungsi untuk update foto profil
        function refreshProfilePicture() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;
            
            updateProfileAvatars(currentUser);
        }
        
        // Fungsi khusus untuk update semua user display elements
        async function updateAllUserDisplays() {
            console.log('ðŸ‘¤ Updating all user display elements...');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                console.log('âŒ No user data in localStorage');
                return;
            }
            
            console.log('ðŸ“¦ Current user data:', currentUser);
            console.log('ðŸ” Available fields:', Object.keys(currentUser));
            console.log('ðŸ“ full_name value:', currentUser.full_name);
            console.log('ðŸ“ username value:', currentUser.username);
            console.log('ðŸ“ email value:', currentUser.email);
            
            // Determine display name dengan prioritas yang benar
            let displayName = currentUser.full_name || 
                             currentUser.username || 
                             currentUser.name ||  // <-- TAMBAH INI untuk field 'name' yang ada
                             currentUser.email?.split('@')[0] || 
                             'User';
            
            console.log('ðŸŽ¯ Selected display name:', displayName);
            
            // Update welcomeUser (desktop navigation)
            const welcomeElement = document.getElementById('welcomeUser');
            if (welcomeElement) {
                welcomeElement.textContent = displayName;
                console.log('âœ… welcomeUser updated to:', displayName);
            } else {
                console.log('âŒ welcomeUser element not found');
            }
            
            // Update email di sebelah welcomeUser
            const emailElement = welcomeElement?.nextElementSibling;
            if (emailElement) {
                // Jika field name berisi email, gunakan itu. Jika tidak, gunakan field email
                const emailToShow = currentUser.email || (currentUser.name && currentUser.name.includes('@') ? currentUser.name : '');
                emailElement.textContent = emailToShow;
            }
            
            // Update mobile welcome user
            const mobileWelcomeUser = document.getElementById('mobileWelcomeUser');
            if (mobileWelcomeUser) {
                mobileWelcomeUser.textContent = displayName;
                console.log('âœ… mobileWelcomeUser updated to:', displayName);
            }
            
            const mobileEmail = mobileWelcomeUser?.nextElementSibling;
            if (mobileEmail) {
                mobileEmail.textContent = currentUser.email || '';
            }
            
            // Update profile dropdown info
            const profileDropdownInfo = document.querySelector('#profileDropdown .border-b p');
            if (profileDropdownInfo) {
                profileDropdownInfo.textContent = displayName;
                console.log('âœ… Profile dropdown name updated to:', displayName);
            }
            
            const profileDropdownEmail = document.querySelector('#profileDropdown .border-b p + p');
            if (profileDropdownEmail) {
                profileDropdownEmail.textContent = currentUser.email || 'user@ayafinance.com';
            }
            
            // Update personal user display
            updatePersonalUserDisplay();
        }

        // Fungsi khusus untuk update personal user display
        function updatePersonalUserDisplay() {
            console.log('ðŸ”„ Updating personal user display...');
            
            // Cek localStorage
            const userDataString = localStorage.getItem('currentUser');
            console.log('ðŸ“¦ Raw localStorage data:', userDataString);
            
            if (!userDataString) {
                console.log('âŒ No current user found in localStorage');
                // Set default untuk testing lokal
                const testElement = document.getElementById('personalUserDisplay');
                if (testElement) {
                    testElement.textContent = 'Data: Test User (No Login Data)';
                    testElement.style.color = 'red';
                }
                return;
            }
            
            const currentUser = JSON.parse(userDataString);
            console.log('ðŸ‘¤ Parsed user data:', currentUser);
            console.log('ðŸ” Available fields:', Object.keys(currentUser));
            console.log('ðŸ“ full_name:', currentUser.full_name);
            console.log('ðŸ“ username:', currentUser.username);
            console.log('ðŸ“ email:', currentUser.email);
            console.log('ðŸ“ name:', currentUser.name);
            console.log('ðŸ“ id:', currentUser.id);
            
            const personalUserDisplay = document.getElementById('personalUserDisplay');
            if (personalUserDisplay) {
                // Coba berbagai kemungkinan field name
                const displayName = 
                    currentUser.full_name || 
                    currentUser.username || 
                    currentUser.name ||    // <-- TAMBAH INI untuk field 'name' yang ada
                    currentUser.email ||
                    `User ID: ${currentUser.id}` ||
                    'Unknown User';
                    
                personalUserDisplay.textContent = `Data: ${displayName}`;
                personalUserDisplay.style.color = ''; // reset color
                console.log('âœ… Personal user display updated to:', personalUserDisplay.textContent);
                
                // Debug tambahan - tampilkan semua field yang tersedia
                console.log('ðŸŽ¯ Final display name selected:', displayName);
                console.log('ðŸ“Š All user fields:', JSON.stringify(currentUser, null, 2));
            } else {
                console.log('âŒ personalUserDisplay element not found');
            }
        }

        // Panggil function ini setelah DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ DOM Content Loaded, calling updatePersonalUserDisplay');
            setTimeout(updatePersonalUserDisplay, 100);
            
            // Multiple attempts untuk memastikan update
            setTimeout(updatePersonalUserDisplay, 500);
            setTimeout(updatePersonalUserDisplay, 1000);
            setTimeout(updatePersonalUserDisplay, 2000);
        });

        // Juga jalankan saat window load
        window.addEventListener('load', function() {
            console.log('ðŸªŸ Window loaded, calling updatePersonalUserDisplay');
            updatePersonalUserDisplay();
        });

        // Force update setiap 3 detik (untuk testing)
        setInterval(function() {
            const element = document.getElementById('personalUserDisplay');
            if (element && element.textContent === 'Data: User') {
                console.log('ðŸ”„ Auto-updating stuck personalUserDisplay...');
                updatePersonalUserDisplay();
            }
        }, 3000);

        // Fungsi utama untuk update profile avatars
        function updateProfileAvatars(user) {
            if (!user) {
                console.log('âŒ No user data provided for profile avatar update');
                return;
            }
            
            const profileElements = document.querySelectorAll('#profileAvatar');
            console.log(`ðŸ–¼ï¸ Found ${profileElements.length} profile avatar elements`);
            
            profileElements.forEach((profileAvatar, index) => {
                // Cek field foto profil yang benar berdasarkan struktur database
                const profilePicture = user.photo_url;
                
                console.log(`ðŸ” Profile picture check for element ${index}:`, {
                    photo_url: user.photo_url,
                    finalPicture: profilePicture,
                    element: profileAvatar
                });
                
                if (profilePicture && profilePicture.trim() !== '') {
                    console.log(`âœ… Setting profile picture for element ${index}:`, profilePicture);
                    
                    // Hapus background gradient dulu
                    profileAvatar.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-cyan-500');
                    
                    // Set gambar dengan error handling
                    profileAvatar.innerHTML = `<img src="${profilePicture}" alt="Foto Profil" class="w-8 h-8 object-cover rounded-full" 
                        onload="console.log('ðŸ–¼ï¸ Profile image loaded successfully for element ${index}')"
                        onerror="console.log('âŒ Profile image failed to load for element ${index}'); this.parentElement.innerHTML='<i class=\\'fas fa-user text-white text-sm\\'></i>'; this.parentElement.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-cyan-500');">`;
                    
                } else {
                    console.log(`âš ï¸ No profile picture found for element ${index}, using default icon`);
                    profileAvatar.innerHTML = `<i class="fas fa-user text-white text-sm"></i>`;
                    profileAvatar.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-cyan-500');
                }
            });
        }
        
        // Listen for storage changes (untuk sync antar tab)
        window.addEventListener('storage', function(e) {
            if (e.key === 'currentUser') {
                console.log('ðŸ”„ User data updated in another tab, refreshing profile picture...');
                refreshProfilePicture();
            }
        });
        
        // Refresh user data from database (optional - jika diperlukan)
        async function refreshUserDataFromDB() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.id) return;
            
            try {
                // Ambil data user terbaru dari database
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('id, full_name, email, username, profile_picture, role, is_active')
                    .eq('id', currentUser.id)
                    .single();
                
                if (!error && userData) {
                    // Update localStorage dengan data terbaru
                    const updatedUser = { ...currentUser, ...userData };
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    
                    console.log('ðŸ”„ User data refreshed from database:', updatedUser);
                    updateProfileAvatars(updatedUser);
                } else {
                    console.log('âš ï¸ Could not refresh user data:', error?.message || error);
                    if (error?.code === '42703') {
                        console.log('ðŸ’¡ Database column error - this is fixed now');
                    }
                }
            } catch (error) {
                console.error('âŒ Error refreshing user data:', error);
                
                // Fallback: gunakan data yang ada di localStorage
                const existingUser = JSON.parse(localStorage.getItem('currentUser'));
                if (existingUser) {
                    console.log('ðŸ”„ Using existing localStorage data as fallback');
                    updateProfileAvatars(existingUser);
                }
            }
        }            // Initialize charts
            setTimeout(() => {
                initializeCharts();
            }, 100);
            
            // Setup ALL event handlers
            setTimeout(() => {
                console.log('ðŸ” Setting up all event handlers...');
             
                // Format ribuan otomatis pada input jumlah transaksi
    const amountInput = document.getElementById('amount');
    if (amountInput) {
        amountInput.addEventListener('input', function(e) {
            // Ambil hanya angka
            let value = this.value.replace(/\D/g, '');
            // Format ribuan
            let formatted = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            this.value = formatted;
        });
    }

                // Add Transaction Button
                const addTransactionBtn = document.getElementById('addTransactionBtn');
                if (addTransactionBtn) {
                    addTransactionBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('ðŸŽ¯ Add transaction button clicked');
                        
                        const modal = document.getElementById('transactionModal');
                        if (modal) {
                            modal.classList.remove('hidden');
                            
                            const dateInput = document.getElementById('transactionDate');
                            if (dateInput) {
                                dateInput.value = new Date().toISOString().split('T')[0];
                            }
                            
                            const form = document.getElementById('transactionForm');
                            if (form) {
                                form.reset();
                            }
                        }
                    });
                }
                
                // Close Modal Button
                const closeModal = document.getElementById('closeModal');
                if (closeModal) {
                    closeModal.addEventListener('click', function() {
                        const modal = document.getElementById('transactionModal');
                        if (modal) modal.classList.add('hidden');
                    });
                }
                
                // Transaction Type Buttons
                const incomeBtn = document.getElementById('incomeBtn');
                const expenseBtn = document.getElementById('expenseBtn');
                
                if (incomeBtn) {
                    incomeBtn.addEventListener('click', function() {
                        selectTransactionType('income');
                    });
                }
                
                if (expenseBtn) {
                    expenseBtn.addEventListener('click', function() {
                        selectTransactionType('expense');
                    });
                }
                
                // Transaction Form
                const transactionForm = document.getElementById('transactionForm');
                if (transactionForm) {
                    transactionForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        handleFormSubmission();
                    });
                }
                
                // Mobile menu toggle
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                const mobileMenu = document.getElementById('mobileMenu');
                
                if (mobileMenuBtn && mobileMenu) {
                    mobileMenuBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log('ðŸ“± Mobile menu toggled');
                        mobileMenu.classList.toggle('hidden');
                        
                        // Close profile dropdown when mobile menu opens
                        const profileDropdown = document.getElementById('profileDropdown');
                        if (profileDropdown && !mobileMenu.classList.contains('hidden')) {
                            profileDropdown.classList.add('hidden');
                        }
                    });
                }
                
                // Profile dropdown handlers
                const profileBtn = document.getElementById('profileBtn');
                const profileDropdown = document.getElementById('profileDropdown');
                const logoutBtn = document.getElementById('logoutBtn');
                const notificationBtn = document.getElementById('notificationBtn');
                
                // Categories button handler
                const categoriesBtn = document.querySelector('button:has(i.fa-tags)') || 
                     document.querySelector('button[class*="orange"]:has(i.fa-tags)') ||
                     Array.from(document.querySelectorAll('button')).find(btn => 
                         btn.textContent.includes('Kelola Kategori'));

if (categoriesBtn) {
    console.log('ðŸ·ï¸ Categories button found:', categoriesBtn);
    categoriesBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸ·ï¸ Categories button clicked - redirecting...');
        window.location.href = 'categories.html';
    };
    console.log('âœ… Categories button handler attached');
} else {
    console.log('âŒ Categories button not found');
}

// Debug Profile Button handler
const debugProfileBtn = document.getElementById('debugProfileBtn');
if (debugProfileBtn) {
    debugProfileBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸ› Debug profile button clicked');
        
        // Update personal user display
        updatePersonalUserDisplay();
        
        const user = JSON.parse(localStorage.getItem('currentUser'));
        console.log('ðŸ‘¤ User data:', user);
        
        // Test profile picture URL
        const profileUrl = user.profile_picture || user.photo_url || user.avatar || user.profile_image;
        console.log('ðŸ–¼ï¸ Profile URL:', profileUrl);
        
        if (profileUrl) {
            // Test if image loads
            const img = new Image();
            img.onload = function() {
                alert(`âœ… Foto profil berhasil dimuat!\nURL: ${profileUrl}\nUkuran: ${this.width}x${this.height}px`);
                forceUpdateAvatar();
            };
            img.onerror = function() {
                alert(`âŒ Foto profil gagal dimuat!\nURL: ${profileUrl}\nPastikan URL valid dan gambar bisa diakses.`);
            };
            img.src = profileUrl;
        } else {
            alert('âš ï¸ Tidak ada URL foto profil ditemukan.\nSilakan upload foto profil di halaman Profile terlebih dahulu.');
        }
    };
    console.log('âœ… Debug profile button handler attached');
}

// Debug User Display Button handler
const debugUserDisplayBtn = document.getElementById('debugUserDisplayBtn');
if (debugUserDisplayBtn) {
    debugUserDisplayBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸ› Debug user display button clicked');
        
        // Check localStorage manually
        const userDataString = localStorage.getItem('currentUser');
        console.log('ðŸ“¦ localStorage currentUser:', userDataString);
        
        if (userDataString) {
            const user = JSON.parse(userDataString);
            console.log('ðŸ‘¤ Parsed user:', user);
        }
        
        // Check DOM element
        const element = document.getElementById('personalUserDisplay');
        console.log('ðŸŽ¯ DOM element:', element);
        console.log('ðŸ“ Current text content:', element ? element.textContent : 'NOT FOUND');
        
        // Force update personal display
        updatePersonalUserDisplay();
        
        // Force update ALL user displays
        updateAllUserDisplays();
        
        // Show result
        setTimeout(() => {
            const newContent = element ? element.textContent : 'ELEMENT NOT FOUND';
            console.log('âœ… Updated text content:', newContent);
            alert(`Personal User Display:\nBefore: Data: User\nAfter: ${newContent}`);
        }, 100);
    };
    console.log('âœ… Debug user display button handler attached');
} else {
    console.log('âŒ Debug user display button not found');
}
                // Profile button click handler
                if (profileBtn && profileDropdown) {
                    profileBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ðŸ‘¤ Profile button clicked');
                        
                        // Close mobile menu if open
                        if (mobileMenu) {
                            mobileMenu.classList.add('hidden');
                        }
                        
                        // Toggle profile dropdown
                        profileDropdown.classList.toggle('hidden');
                        console.log('Profile dropdown toggled:', !profileDropdown.classList.contains('hidden'));
                    });
                }
                
                // Notification button handler
                if (notificationBtn) {
                    notificationBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('ðŸ”” Notification clicked');
                        alert('Fitur notifikasi akan segera hadir!');
                    });
                }
                
                // Logout button handler
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('ðŸšª Logout clicked');
                        if (confirm('Apakah Anda yakin ingin logout?')) {
                            localStorage.removeItem('currentUser');
                            sessionStorage.clear();
                            window.location.href = '../index.html';
                        }
                    });
                }
                
                // Profile menu items handlers
                const profileMenuItems = document.querySelectorAll('#profileDropdown a');
                profileMenuItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const text = this.textContent.trim();
                        
                        console.log('ðŸ“‹ Profile menu clicked:', text);
                        
                        switch(text) {
                            case 'Profile Saya':
                                window.location.href = 'profil.html';
                                break;
                            case 'Pengaturan':
                                alert('Fitur Pengaturan akan segera hadir!');
                                break;
                            case 'Refresh Profile':
                                console.log('ðŸ”„ Manual profile refresh requested...');
                                
                                // Show loading state
                                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
                                
                                // Update avatar dengan data saat ini dulu
                                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                                updateProfileAvatars(currentUser);
                                
                                // Kemudian refresh dari database
                                refreshUserDataFromDB().then(() => {
                                    // Reset button text
                                    setTimeout(() => {
                                        this.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh Profile';
                                        
                                        // Update sekali lagi setelah data dari DB
                                        const updatedUser = JSON.parse(localStorage.getItem('currentUser'));
                                        updateProfileAvatars(updatedUser);
                                    }, 1500);
                                });
                                break;
                            case 'Notifikasi':
                                alert('Fitur Notifikasi akan segera hadir!');
                                break;
                            default:
                                console.log('Unknown menu item:', text);
                        }
                        
                        // Close dropdown after selection
                        if (profileDropdown) {
                            profileDropdown.classList.add('hidden');
                        }
                    });
                });
                
                console.log('âœ… All event handlers setup complete');
                
            }, 500);
            
            // SINGLE outside click handler
            document.addEventListener('click', function(e) {
                const profileBtn = document.getElementById('profileBtn');
                const profileDropdown = document.getElementById('profileDropdown');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                const mobileMenu = document.getElementById('mobileMenu');
                const transactionModal = document.getElementById('transactionModal');
                
                // Close profile dropdown
                if (profileBtn && profileDropdown && 
                    !profileBtn.contains(e.target) && 
                    !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                }
                
                // Close mobile menu
                if (mobileMenuBtn && mobileMenu && 
                    !mobileMenuBtn.contains(e.target) && 
                    !mobileMenu.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
                
                // Close modal on backdrop click
                if (transactionModal && e.target === transactionModal) {
                    transactionModal.classList.add('hidden');
                }
            });
            
            // Close dropdowns on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const profileDropdown = document.getElementById('profileDropdown');
                    const mobileMenu = document.getElementById('mobileMenu');
                    const transactionModal = document.getElementById('transactionModal');
                    
                    if (profileDropdown) profileDropdown.classList.add('hidden');
                    if (mobileMenu) mobileMenu.classList.add('hidden');
                    if (transactionModal) transactionModal.classList.add('hidden');
                }
            });
            
            // Load dashboard data
            loadDashboardData();
            
            // Refresh user data dari database (untuk memastikan foto profil terbaru)
            setTimeout(() => {
                refreshUserDataFromDB();
            }, 1000);
            
            console.log('âœ… Dashboard initialized successfully');
            
            // Debug functions - tersedia di console browser
            window.debugUser = function() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                console.log('ðŸ‘¤ Current User Data:', user);
                return user;
            };
            
            window.refreshProfile = function() {
                console.log('ðŸ”„ Manual profile refresh...');
                refreshUserDataFromDB();
            };
            
            window.updatePersonalDisplay = function() {
                console.log('ðŸ”„ Manual personal display update...');
                updatePersonalUserDisplay();
            };
            
            window.updateAllDisplays = function() {
                console.log('ðŸ”„ Manual all displays update...');
                updateAllUserDisplays();
            };
            
            window.updateAvatars = function() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                console.log('ðŸ”„ Manual avatar update...');
                updateProfileAvatars(user);
            };
            
            window.testProfilePicture = function() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                const profilePicture = user.profile_picture || user.photo_url || user.avatar || user.profile_image;
                console.log('ðŸ–¼ï¸ Profile Picture URL:', profilePicture);
                console.log('ðŸ” User Profile Data:', {
                    profile_picture: user.profile_picture,
                    photo_url: user.photo_url,
                    avatar: user.avatar,
                    profile_image: user.profile_image
                });
                
                if (profilePicture) {
                    console.log('ðŸ§ª Testing image load...');
                    const img = new Image();
                    img.onload = () => {
                        console.log('âœ… Image loads successfully');
                        console.log('ðŸ“ Image dimensions:', img.width + 'x' + img.height);
                    };
                    img.onerror = () => {
                        console.log('âŒ Image failed to load');
                        console.log('ðŸ”— URL that failed:', profilePicture);
                    };
                    img.src = profilePicture;
                } else {
                    console.log('âš ï¸ No profile picture URL found');
                }
                return profilePicture;
            };
            
            window.forceUpdateAvatar = function() {
                console.log('ðŸ’ª Force updating all profile avatars...');
                const user = JSON.parse(localStorage.getItem('currentUser'));
                console.log('User data:', user);
                
                // Update semua avatar dengan force
                const avatars = document.querySelectorAll('#profileAvatar');
                console.log('Found avatars:', avatars.length);
                
                avatars.forEach((avatar, index) => {
                    console.log(`Updating avatar ${index}:`, avatar);
                    updateProfileAvatars(user);
                });
            };
            
            // Tambahkan immediate test saat page load
            setTimeout(() => {
                console.log('ðŸ§ª Running immediate profile picture test...');
                const user = JSON.parse(localStorage.getItem('currentUser'));
                
                if (user) {
                    console.log('ðŸ‘¤ Current user:', user.username || user.full_name);
                    console.log('ðŸ” Profile fields check:', {
                        profile_picture: user.profile_picture ? 'âœ… Found' : 'âŒ Not found',
                        photo_url: user.photo_url ? 'âœ… Found' : 'âŒ Not found', 
                        avatar: user.avatar ? 'âœ… Found' : 'âŒ Not found',
                        profile_image: user.profile_image ? 'âœ… Found' : 'âŒ Not found'
                    });
                    
                    const finalUrl = user.profile_picture || user.photo_url || user.avatar || user.profile_image;
                    console.log('ðŸ–¼ï¸ Final URL to use:', finalUrl);
                    
                    if (finalUrl) {
                        console.log('âœ… Profile picture URL found, attempting to display...');
                    } else {
                        console.log('âš ï¸ No profile picture URL found - will show default icon');
                        // Optional: Show notification to user
                        // alert('Foto profil tidak ditemukan. Silakan upload foto profil di halaman Profile.');
                    }
                    
                    const avatarElements = document.querySelectorAll('#profileAvatar');
                    console.log(`ðŸŽ¯ Found ${avatarElements.length} avatar elements to update`);
                    
                    // Force update sekali lagi
                    updateProfileAvatars(user);
                    
                } else {
                    console.log('âŒ No user data found in localStorage');
                }
            }, 2000);
            
            console.log('ðŸ› ï¸ Debug functions available: debugUser(), refreshProfile(), testProfilePicture(), updateAvatars(), forceUpdateAvatar()');
        });
        
        console.log('âœ… Clean dashboard script loaded');

        // Chat AI Frontend
document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    appendMessage('Anda', msg);
    input.value = '';
    appendMessage('AI', '<i class="fas fa-spinner fa-spin"></i>');

    // Kirim ke backend
    const res = await fetch('https://ayafinancev3-production.up.railway.app/api/chat', {        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg, userId: currentUser.id })
    });
    const data = await res.json();
    removeLastMessage(); // Remove spinner
    appendMessage('AI', data.reply);
});

function appendMessage(sender, text) {
    const chat = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.innerHTML = `<b>${sender}:</b> ${text}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

const chatAI = document.getElementById('chatAI');
const chatAITab = document.getElementById('chatAITab');
const closeChatAI = document.getElementById('closeChatAI');

// Show Chat AI window dengan animasi
chatAITab.addEventListener('click', function() {
    chatAI.style.display = 'block';
    setTimeout(() => {
        chatAI.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
        chatAI.classList.add('opacity-100', 'scale-100');
    }, 10);
});

// Hide Chat AI window dengan animasi
closeChatAI.addEventListener('click', function() {
    chatAI.classList.remove('opacity-100', 'scale-100');
    chatAI.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
    setTimeout(() => {
        chatAI.style.display = 'none';
    }, 300); // sesuai duration-300
});

function removeLastMessage() {
    const chat = document.getElementById('chatMessages');
    if (chat.lastChild) chat.removeChild(chat.lastChild);
}
    </script>
</body>

</html>